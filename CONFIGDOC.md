When you define an automated pipeline of tasks in Jenkins&trade;, whether in the web UI or with a [`Jenkinsfile`](https://www.jenkins.io/doc/book/pipeline/jenkinsfile/), you can use the plugin to run your MATLAB&reg; code or Simulink&reg; models. This guide demonstrates how to configure the plugin and use it in freestyle, multi-configuration, and Pipeline projects.


-  [Configure Plugin in Web UI](#configure-plugin-in-web-ui)
      -  [Use MATLAB in Build](#use-matlab-in-build)
      -  [Specify Build Steps](#specify-build-steps)
         - [Run MATLAB Command](#run-matlab-command)
         - [Run MATLAB Tests](#run-matlab-tests)
-  [Set Up Freestyle Project](#set-up-freestyle-project)
-  [Set Up Multi-Configuration Project](#set-up-multi-configuration-project)
-  [Set Up Pipeline Project](#set-up-pipeline-project)
   -  [Add MATLAB to System Path](#add-matlab-to-system-path)
   -  [Use the runMATLABCommand Step](#use-the-runmatlabcommand-step)
   -  [Use the runMATLABTests Step](#use-the-runmatlabtests-step) 
   -  [Use MATLAB in Matrix Build](#use-matlab-in-matrix-build)
-  [Register MATLAB as a Jenkins Tool](#register-matlab-as-a-jenkins-tool)
   -  [Use MATLAB as a Tool in Pipeline Project](#use-matlab-as-a-tool-in-pipeline-project)

## Configure Plugin in Web UI
You can use the web UI provided by Jenkins to configure the plugin in freestyle and multi-configuration projects. To run MATLAB or Simulink in a Pipeline project, see [Set Up Pipeline Project](#set-up-pipeline-project).

### Use MATLAB in Build
Once you install the plugin, **Use MATLAB version** appears in the **Build Environment** section of the project configuration window.


![matlab_path](https://user-images.githubusercontent.com/48831250/94472251-75ec2880-0198-11eb-8d95-7a67c802cae8.png)

Select **Use MATLAB version** to specify the full path to the MATLAB root folder that should be used for the build. The information in the **MATLAB root** box enables the plugin to prepend MATLAB to the system PATH environment variable of the build agent. 

If the build agent already has your desired MATLAB on the path, then you are not required to select **Use MATLAB version**. The plugin uses the first MATLAB version it encounters on the system path. The build fails if the operating system cannot find MATLAB on the path.

**Note:** The [`matlabroot`](https://www.mathworks.com/help/matlab/ref/matlabroot.html) function returns the full path to the MATLAB root folder, which depends on the platform, MATLAB version, and installation location. This table shows examples of the root folder path on different platforms. 

| Platform     | Path to MATLAB Root Folder      |
|--------------|---------------------------------|
| Windows&reg; | C:\Program Files\MATLAB\R2020b  |
| Linux&reg;   | /usr/local/MATLAB/R2020b        |
| macOS        | /Applications/MATLAB_R2020b.app |

### Specify Build Steps
When you set up the **Build** section of the project configuration window, the plugin provides you with the **Run MATLAB Command** and **Run MATLAB Tests** build steps.

If you use a source code management (SCM) system such as Git&trade;, then your project should include the appropriate SCM configuration to check out the code before it can invoke the plugin. If you do not use any SCM systems to manage your code, then an additional build step might be required to ensure that the code is available in the Jenkins workspace before the build starts.

#### Run MATLAB Command
The **Run MATLAB Command** build step enables you to specify MATLAB commands tailored to your specific needs. For example, you can use this build step to customize your test run or add a different build step to your Pipeline.

If you specify more than one MATLAB command, use a comma or semicolon to separate the commands. The build fails if the execution of any command results in an error.

![run_matlab_command](https://user-images.githubusercontent.com/48831250/94472499-d8ddbf80-0198-11eb-8f25-ead3c4039f55.png)


If you need to specify several MATLAB commands, consider writing a MATLAB script or function as part of your repository and executing this script or function instead. 

Test artifacts are not autogenerated if you choose to run tests using this build step. You can generate your desired test artifacts by configuring the test runner in the script or function that you invoke from the **Command** box.

#### Run MATLAB Tests
This build step uses a default setting to run tests authored using the MATLAB Unit Testing Framework or Simulink Test&trade;. If your source code is organized into files and folders within a MATLAB project, then the plugin includes any test files in the project that have been labeled as `Test`. If your code does not leverage a MATLAB project or uses a MATLAB release before R2019a, then the plugin includes all tests in the project workspace, including its subfolders.

With the **Run MATLAB Tests** build step, you can specify the locations of source code folders relative to the project root folder. When you specify a folder in the **Folder path** box, the plugin adds the folder and its subfolders to the top of the MATLAB search path. You can specify more folders by clicking **Add Folder**. If you specify source code folders and then choose to generate a coverage report, MATLAB uses only the code in the specified folders and their subfolders to generate the report. 

 ![run_matlab_tests](https://user-images.githubusercontent.com/48831250/94472880-64efe700-0199-11eb-8c2f-e733f104ba95.png)

The **Run MATLAB Tests** build step enables you to generate different types of test artifacts. To publish the test results, you can use these artifacts with other Jenkins plugins. By default, the plugin assigns a name to each selected artifact and stores it in the `matlabTestArtifacts` folder of the project workspace. You can override the default artifact name and location by specifying a path relative to the project folder in the **File path** box. If you leave the text box empty, the plugin does not generate an artifact. If you do not select any of the test artifact check boxes, the tests still run, and test failures fail the build.  

The **Run MATLAB Tests** build step produces a MATLAB script file and uses it to run the tests and generate the test artifacts. The plugin writes the contents of this file to the build log. You can review the build log in **Console Output** to understand the testing workflow.
 
**Note:**
* The plugin does not create the `matlabTestArtifacts` folder if the name of the folder does not appear in any of the displayed **File path** boxes.

* Producing a PDF test report is not currently supported on macOS platforms.
 
## Set Up Freestyle Project
To configure the plugin for a freestyle project, specify the location where MATLAB is installed as well as the required build steps.

1) In the **Build Environment** section of the project configuration window, select **Use MATLAB version**. Then, enter the full path to the MATLAB root folder in the **MATLAB root** box. (You can skip this step if MATLAB has already been added to the path on the build agent.)

![build_environment](https://user-images.githubusercontent.com/48831250/94472063-31f92380-0198-11eb-90c1-adb48e7f5f2b.png)

  
2) Add the required build steps in the **Build** section:
   *   If you add the [**Run MATLAB Tests**](#run-matlab-tests) build step, specify the source code and the artifacts to be generated in the project workspace.
   *   If you add the [**Run MATLAB Command**](#run-matlab-command) build step, enter your commands in the **Command** box. 

## Set Up Multi-Configuration Project
The plugin supports [multi-configuration (matrix) projects](https://plugins.jenkins.io/matrix-project/). Multi-configuration projects are useful when builds include similar steps. For example:
* The same test suite is run on different platforms (Windows, Linux, and macOS).
* The same test suite is run against different versions of MATLAB.

To configure the plugin for a multi-configuration project, specify the locations where MATLAB is installed as well as the required build steps. In addition, add user-defined axes in the **Configuration Matrix** section to specify the duplicating build steps. 

1) Add a user-defined axis in the **Configuration Matrix** section to represent the MATLAB versions in the build. Specify the name of the axis in the **Name** box and its values in the **Values** box. Separate the values with a space. In this example, four MATLAB versions are specified to run the same set of tests.

![axis_version](https://user-images.githubusercontent.com/48831250/94473728-96b57d80-019a-11eb-8e53-7e8960430e9b.png)


You can define several axes in the **Configuration Matrix** section. For example, add the TEST_TAG axis specifying the possible test tags for a group of tests.

![axis_version_testtag](https://user-images.githubusercontent.com/48831250/94474181-4559be00-019b-11eb-9e22-6771f353505b.png)


2) In the **Build Environment** section, select **Use MATLAB version** and then specify the locations where MATLAB is installed using the user-defined axis name. In this example, **$VERSION** in the **MATLAB root** box is replaced by one axis value per build iteration. 

![build_environment_matrix](https://user-images.githubusercontent.com/48831250/94474620-e779a600-019b-11eb-8b6a-7e308484c591.png)


3) Add the required build steps in the **Build** section:
   *   If you add the [**Run MATLAB Tests**](#run-matlab-tests) build step, specify the source code and the artifacts to be generated in the project workspace.
   *   If you add the [**Run MATLAB Command**](#run-matlab-command) build step, enter your commands in the **Command** box. You can use the user-defined axes to create your commands. For example:

![run_matlab_command_matrix](https://user-images.githubusercontent.com/48831250/94475242-c9607580-019c-11eb-9ee5-8a0d2f95f5bf.png)


**Note:**
* Both **$VAR** and **${VAR}** are valid formats for accessing the values of the user-defined axis **VAR**. On macOS platforms, the **${VAR}** format is recommended.

* A multi-configuration project creates a separate workspace for each user-defined axis value. If you specify the full paths to where MATLAB is installed as axis values, Jenkins fails to create separate workspaces and fails the build.

## Set Up Pipeline Project
When you define your Pipeline with a `Jenkinsfile`, the plugin provides you with a step to run MATLAB scripts, functions, and statements. The plugin also provides a step to run MATLAB and Simulink tests. (These steps are common to both Declarative and Scripted Pipelines.) 

To configure the plugin for a Pipeline project:
1) Define your Pipeline in a `Jenkinsfile` in the root of your repository.
2) In the **Pipeline** section of the project configuration window, select **Pipeline script from SCM** from the **Definition** drop-down list. 
3) Select your source control system from the **SCM** drop-down list.
4) Paste your repository URL into the **Repository URL** box.

You also can define your Pipeline directly in the project configuration window. If you select **Pipeline script** from the **Definition** drop-down list, you can author your Pipeline code in the **Script** box. When you define your Pipeline this way, your Pipeline must include an additional stage to check out MATLAB code from source control.

### Add MATLAB to System Path
When Jenkins executes MATLAB-related steps in your Pipeline, it uses the first MATLAB version on the system path. If the PATH environment variable of the build agent does not include any MATLAB versions, you must update the variable with the MATLAB root folder that should be used for the build.

To update the system PATH environment variable using Declarative Pipeline syntax, use an `environment` block in your `Jenkinsfile`. For example, prepend MATLAB R2020b to the system PATH environment variable and use it to run your command.

```groovy
// Declarative Pipeline
pipeline {
   agent any
   environment {
       PATH = "C:\\Program Files\\MATLAB\\R2020b\\bin;${PATH}"   // Windows agent
    // PATH = "/usr/local/MATLAB/R2020b/bin:${PATH}"   // Linux agent
    // PATH = "/Applications/MATLAB_R2020b.app/bin:${PATH}"   // macOS agent    
   }
    stages{
        stage('Run MATLAB Command') {
            steps
            {
               runMATLABCommand "disp('Hello World!')"
            }       
        }                
    } 
}
``` 
If you define your Pipeline using Scripted Pipeline syntax, set the PATH environment variable in the `node` block. For example: 

```groovy
// Scripted Pipeline
node {
        env.PATH = "C:\\Program Files\\MATLAB\\R2020b\\bin;${env.PATH}"   //Windows agent
     // env.PATH = "/usr/local/MATLAB/R2020b/bin:${env.PATH}"   //Linux agent
     // env.PATH = "/Applications/MATLAB_R2020b.app/bin:${env.PATH}"   //macOS agent
        runMATLABCommand "disp('Hello World!')"
}
``` 

### Use the runMATLABCommand Step
Use the `runMATLABCommand` step in your Pipeline to run MATLAB scripts, functions, and statements tailored to your specific needs. You can use this task to flexibly customize your test run or run any MATLAB commands.

You must provide `runMATLABCommand` with a string that specifies the command you want to execute. If the command is the name of a MATLAB script or function, do not specify the file extension. If you specify more than one MATLAB command, use a comma or semicolon to separate the commands.

**Example:** `runMATLABCommand 'myscript'`<br/>
**Example:** `runMATLABCommand 'results = runtests, assertSuccess(results);'` 

For example, in your `Jenkinsfile`, define a Declarative Pipeline to run the commands in a file named `myscript.m`.


```groovy
// Declarative Pipeline
pipeline {
    agent any
    stages{
        stage('Run MATLAB Command') {
            steps
            {
                runMATLABCommand 'myscript'
            }       
        }                
    } 
}
``` 

You also can use `runMATLABCommand` in a Scripted Pipeline.

```groovy
// Scripted Pipeline
node {
    runMATLABCommand 'myscript'  
}
``` 

MATLAB exits with exit code 0 if the specified script, function, or statement executes successfully without error. Otherwise, MATLAB terminates with a nonzero exit code, which causes the build to fail. You can use the [`assert`](https://www.mathworks.com/help/matlab/ref/assert.html) or [`error`](https://www.mathworks.com/help/matlab/ref/error.html) functions in the command to ensure that builds fail when necessary.

When you use the `runMATLABCommand` step, all of the required files must be on the MATLAB search path.

### Use the runMATLABTests Step

Use the `runMATLABTests` step in your Pipeline to run all tests in your MATLAB project and generate artifacts. MATLAB includes any files in your project that have a `Test` label. If your Pipeline does not leverage a MATLAB project or uses a MATLAB release before R2019a, then MATLAB includes all tests in the the root of your repository, including its subfolders.

For example, in your `Jenkinsfile`, define a Declarative Pipeline to run the tests in your project and fail the build if any of the tests fails.


```groovy
// Declarative Pipeline
pipeline {
    agent any
    stages{
        stage('Run MATLAB Tests') {
            steps
            {
                runMATLABTests()
            }       
        }                
    } 
}
``` 

 Use the `runMATLABTests` step in a Scripted Pipeline to run the tests in your project.

```groovy
// Scripted Pipeline
node {
    runMATLABTests()  
}
``` 

 To generate artifacts using the `runMATLABTests` step, provide the step with one or more name-value pair arguments to specify the artifacts and the locations to save them. Use a colon to separate names and values.

 For example, define a Declarative Pipeline to run the tests in your MATLAB project, and then generate a JUnit test results report and a Cobertura code coverage report at specified locations on the build agent. Generate the coverage report for only the code in the `source` folder located in the root of your repository. 


```groovy
// Declarative Pipeline
pipeline {
    agent any
    stages{
        stage('Run MATLAB Tests') {
            steps
            {
                runMATLABTests(testResultsJUnit: 'test-results/results.xml',
                               codeCoverageCobertura: 'code-coverage/coverage.xml',
                               sourceFolder: ['source'])
            }       
        }                
    } 
}
``` 

Define a Scripted Pipeline to run your tests and generate artifacts.

```groovy
// Scripted Pipeline
node {
    runMATLABTests(testResultsJUnit: 'test-results/results.xml',
                   codeCoverageCobertura: 'code-coverage/coverage.xml',
                   sourceFolder: ['source']) 
}
``` 


 
 This table lists the name-value pair arguments that you can specify with the `runMATLABTests` step.

| Name               	| Value                                                                                                                	|
|-------------------------	|----------------------------------------------------------------------------------------------------------------------------	|
| testResultsPDF          	| Path to write test results report in PDF format (currently not supported on macOS platforms).<br/>**Example:** `'test-results/results.pdf'`                  	|
| testResultsTAP          	| Path to write test results report in TAP format.<br/>**Example:** `'test-results/results.tap'`                  	|
| testResultsJUnit        	| Path to write test results report in JUnit XML format.<br/>**Example:** `'test-results/results.xml'`            	|
| testResultsSimulinkTest 	| Path to export Simulink Test Manager results in MLDATX format (requires Simulink Test license and is supported in MATLAB R2019a or later).<br/>**Example:** `'test-results/results.mldatx'` 	|
| codeCoverageCobertura   	| Path to write code coverage report in Cobertura XML format.<br/>**Example:** `'code-coverage/coverage.xml'`     	|
| modelCoverageCobertura  	| Path to write model coverage report in Cobertura XML format (requires Simulink Coverageâ„¢ license and is supported in MATLAB R2018b or later).<br/>**Example:** `'model-coverage/coverage.xml'`   	|
| sourceFolder  	| Locations of the folders containing source code, relative to the project root folder. The specified folders and their subfolders are added to the top of the MATLAB search path. To generate a coverage report, MATLAB uses only the source code in the specified folders and their subfolders. <br/>**Example:** `['source']`<br/>**Example:** `['src/folderA', 'src/folderB']`   	|


## Use MATLAB in Matrix Build
Similar to multi-configuration projects, you can use MATLAB as part of a [matrix](https://www.jenkins.io/doc/book/pipeline/syntax/#declarative-matrix) build in Pipeline projects. For example, you can define a Pipeline to run your test suite on different platforms or against different versions of MATLAB.

This example shows how to define a Declarative Pipeline to run your MATLAB code and generate test artifacts using MATLAB R2018b, R2019a, and R2020b. The Pipeline has a `matrix` block to define the possible name-value combinations that should run in parallel. 

```groovy
// Declarative Pipeline
pipeline {
    agent any
    stages {
        stage('BuildAndTest') {
            matrix {
                agent any
                environment {
                    PATH = "C:\\Program Files\\MATLAB\\${MATLAB_VERSION}\\bin;${PATH}"   // Windows agent
                }
                axes {
                    axis {
                        name 'MATLAB_VERSION'
                        values 'R2018b', 'R2019a', 'R2020b'
                    }
                }
                stages {
                    stage('Run MATLAB commands') {
                        steps {
                            runMATLABCommand 'ver'
                            runMATLABCommand 'pwd'
                        }
                    }
                    stage('Run MATLAB tests'){
                        steps {
                            runMATLABTests(testResultsJUnit: 'test-results/results.xml',
                                           codeCoverageCobertura: 'code-coverage/coverage.xml')
                        }  
                    }
                }
            } 
        }
    }
}
``` 

## Register MATLAB as a Jenkins Tool
To run MATLAB code and Simulink models as part of your automated pipeline of tasks, Jenkins invokes MATLAB as an external program. When you configure your project, you can explicitly specify the MATLAB version that Jenkins should invoke by providing the path to the desired MATLAB root folder. For example, you can use an `environment` block in your `Jenkinsfile` to specify a MATLAB root folder for your Pipeline project.

Instead of specifying the path to the MATLAB root folder on a per project basis, you can register MATLAB as a Jenkins tool, which can then be accessed by any project you configure in Jenkins. To register your desired MATLAB version as a tool, you are required to specify its name and location on the build agent. Once you have registered MATLAB as a tool, you no longer need to specify its root folder path within a project. Jenkins only needs the tool name to access MATLAB.

To register MATLAB as a Jenkins tool:

1) In your Jenkins interface, select **Manage Jenkins > Global Tool Configuration**. A new page opens where you can register different tools with Jenkins.
2) In the **MATLAB** section of the **Global Tool Configuration** page, locate and click **Add MATLAB**. The section expands and enables you to specify the name and installation location of MATLAB.
3) specify the name for your desired MATLAB version in the **MATLAB Name** box, and enter the full path to the MATLAB root folder in the **MATLAB root** box. To register MATLAB as a tool, you are not required to select **Install automatically**. 
4) To confirm your choices, click **Save** at the bottom of the page.

For example, register MATLAB R2020b as a Jenkins tool on your Windows-based local agent.

![matlab_tool](https://user-images.githubusercontent.com/48831250/98566654-0714eb80-227d-11eb-90b8-4875ab32bf66.png)

If your Jenkins instance includes remote agents, you can register MATLAB as a tool on the remote agents using the tool name that you have specified on the local agent. For example, if you have registered MATLAB R2020b as a tool on your local agent, you can register the same MATLAB version installed on a remote agent as a tool on the remote agent. To register MATLAB as a Jenkins tool on a remote agent: 

1) Navigate to the **Node Properties** interface of the agent. You can access this interface by selecting **Manage Jenkins > Manage Nodes and Clouds**, clicking the link corresponding to the agent, and then selecting **Configure** on the left.
2) Select **Tool Locations**. Then, select the tool name from the **Name** drop-down list. The list contains the names assigned to the registered MATLAB versions on the local agent.  
3) In the **Home** box, enter the full path to the MATLAB root folder on the remote agent.
4) Click **Save** to confirm your choices.

For example, on a Linux-based remote agent, register MATLAB R2020b as a tool.

![tool_remote](https://user-images.githubusercontent.com/48831250/98685471-67676400-2335-11eb-9db5-bd027bc053f6.PNG)

**Note:** Currently, using MATLAB as a tool is supported only for Pipeline projects.

### Use MATLAB as a Tool in Pipeline Project
To invoke MATLAB as a Jenkins tool using Declarative Pipeline syntax, use a `tools` block in your `Jenkinsfile`. To specify the tool in the block, use the `matlab` keyword followed by the name assigned to the tool on the **Global Tool Configuration** page. For example, use the MATLAB version that has been defined as a tool named R2020b to run the commands in the file `myscript.m`.  

```groovy
// Declarative Pipeline
pipeline {
   agent any
   tools {
       matlab 'R2020b'
   }
    stages{
        stage('Run MATLAB Command') {
            steps
            {
               runMATLABCommand 'myscript'
            }       
        }                
    } 
}

```

If you define your Pipeline using Scripted Pipeline syntax, you need to prepend the path to the `bin` folder of the desired MATLAB version to the PATH environment variable. Use the `tool` keyword following by the name of the tool to retrieve the path to the MATLAB root folder. Then, construct the path to the `bin` folder, and use `withEnv` to prepend it to the PATH environment variable.

```groovy
// Scripted Pipeline
node {
    def matlabver
    stage('Run MATLAB Command') {
        // Specify the matlabroot/bin folder for the desired MATLAB version
        matlabver = tool 'R2020b'
        if (isUnix()){
            matlabver = matlabver + "/bin"   // Linux or macOS agent
        }else{
            matlabver = matlabver + "\\bin"   // Windows agent
        }   
        withEnv(["PATH + MATLAB = $matlabver"]) {   // Prepend matlabroot/bin to the PATH variable
            runMATLABCommand 'myscript'
        }
    }
}
```
You also can invoke MATLAB as a Jenkins tool when you perform a matrix build in your Pipeline project. This example shows how to use three MATLAB versions (specified in an `axis` block using their corresponding tool names) to run a set of MATLAB commands and tests. 

```groovy
// Declarative Pipeline
pipeline {
    agent any
    stages {
        stage('BuildAndTest') {
            matrix {
                agent any
                axes {
                    axis {
                        name 'MATLAB_VERSION'
                        values 'R2018b', 'R2019a', 'R2020b'
                    }
                }
                tools{
                    matlab "${MATLAB_VERSION}"
                }
                stages {
                    stage('Run MATLAB commands') {
                        steps {
                            runMATLABCommand 'ver'
                            runMATLABCommand 'pwd'
                        }
                    }
                    stage('Run MATLAB Tests') {
                    steps
                        {
                            runMATLABTests(testResultsJUnit: 'test-results/results.xml',
                                           codeCoverageCobertura: 'code-coverage/coverage.xml')
                        }
                    }
                }
            }
        }
    }
}
```


## See Also
[Run MATLAB Tests on Jenkins Server](examples/Run-MATLAB-Tests.md)<br/>
[Continuous Integration (MATLAB)](https://www.mathworks.com/help/matlab/continuous-integration.html)<br/>
[Continuous Integration (Simulink Test)](https://www.mathworks.com/help/sltest/continuous-integration.html)
